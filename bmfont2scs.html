<script> 
/** 

@author Soundwave2142
https://steamcommunity.com/id/Soundwave2142/

02.28.2021

**/

</script>

<body class="main-body">

<div class="main-block">
    Select bmfont file (.fnt) :
    <input type="file" id="file-input" single>
    <div>

        <hr>
        <button type="button" style="display:none;" id="convert-btn"> Convert </button>

    </div>
</div>

<script>
  document.getElementById("file-input").addEventListener('change', (event) => {
    document.getElementById("convert-btn").style = "";
  });
  
  document.getElementById('convert-btn').addEventListener('click', (event) => {
  
	    var fr=new FileReader(); 		
        fr.onload=function(){ 
			var generalInfo = {
			    vert_span: find(fr.result, 'base='),
				line_spacing: 0,
				width: find(fr.result, 'scaleW='),
				height: find(fr.result, 'scaleH='),
				filename: find(fr.result, 'file="').split('.')[0]
			};
			
            var kerning = [], coordinates = [];
			
			fr.result.split(/\r?\n/).forEach(function(line){
			    if(line.startsWith("char id=")){
                    var result = handleData(line);
				    if(result){
					    coordinates.push(result);
					}
				} else if (line.startsWith("kerning first=")){
				    var result = handleData(line, true);
				    if(result){
					    kerning.push(result);
					}
				};
				
			});
			
			kerning.sort(sortFunction);
			
			outputData(generalInfo, coordinates, kerning);
        } 
			
        fr.readAsText(document.getElementById("file-input").files[0]); 
  });
  
  function outputData(info, coords, kerning){
    var result = 'vert_span:' + info.vert_span + '\nline_spacing:' + info.line_spacing + '\n\nimage:' + info.filename + '.mat, ' + info.width + ', ' + info.height + '\n\n';
	
	result += '#NUM,    P_x, P_y,  W,  H,  L,  T,  A,  I     # character / glyph name\n\n';
	coords.forEach(function(setOfCoords){
	
	    setOfCoords.forEach(function(coord, key){
		    var itemLength = coord.length;
		    var max = key > 2 ? 3 : 5;
			  
		    coord += setOfCoords.length > (key + 1) ? ',' : '';
		    for(var i = 0; i < (max - itemLength); i++){coord = ' ' + coord;}
			
			result += coord;
		});
		
		result += '     # \'' + unicode(setOfCoords[0]) + '\'\n';
	});
	
	result += '\n# kerning...\n\n';
	kerning.forEach(function(setOfKerns){
	    result += 'kern: ' + setOfKerns[0] + ', ' + setOfKerns[1] + ', ' + setOfKerns[2] + '      # \'' + unicode(setOfKerns[0]) + '\' -> \'' + unicode(setOfKerns[1]) + '\'\n';
	});
	
	download(info.filename + '.font', result);
	
	var mat = 'material : "ui.white_font" {\n	texture : "' + info.filename + '.tobj"\n	texture_name : "texture"\n}\n'
	download(info.filename + '.mat', mat);
	
	var tobj = 'map 2d	' + info.filename + '.tga\naddr\n     clamp_to_edge\n     clamp_to_edge\ncolor_space linear\nnomips\nnocompress\n';
	download(info.filename + '.tobj', tobj);
  }
  
  function unicode(hex){
    return String.fromCodePoint(parseInt(hex.substring(1), 16))
  }
  
  function download(filename, text) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
  }
  
  function handleData(item, kerning = false){
	var arrayCoords = [];
	
    item.replace(/[^0-9 \-+]+/g, "").split(" ").forEach(function(coords, key){
		if(coords !== ''){
		    arrayCoords.push(coords);
		}
	});
	
	if(arrayCoords.length > 0){
	    arrayCoords[0] = decToHex(arrayCoords[0]);
		
	    if(!kerning){
	        arrayCoords.pop();
	    }else{
		    arrayCoords[1] = decToHex(arrayCoords[1]);
		}
		
	    return arrayCoords;
	}
	
	return false;
  }
  
  function sortFunction(a, b) {
    if (a[0] === b[0]) {
        return 0;
    }
    else {
        return (a[0] < b[0]) ? -1 : 1;
    }
  }
  
  function decToHex(val){
        var element = parseInt(val).toString(16);
		var prefix = 'x';
		
		for (var i = element.length; i < 4; i++){
		    prefix += '0';
		}
		
		return prefix + element;
  }
  
  function find(str, needle){
    var index = str.indexOf(' ', str.indexOf(needle) + needle.length);
	index = str.indexOf('\n', str.indexOf(needle) + needle.length) < index ? str.indexOf('\n', str.indexOf(needle) + needle.length) : index;
    return str.substring(str.indexOf(needle) + needle.length, index);
  }
  
</script>

<style>

#convert-btn:hover{
    cursor:pointer;
    background-color:#1770ff;
}

#convert-btn{
    border: none;
    color: white;
    padding: 20px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin: 4px 2px;
    background-color:#6673ff;
    border-radius: 12px;
}

.main-body{
    background-color: #a7d0db;
}

.main-block{
    text-align:center;
    margin:50px;
    padding:50px;
    background-color: #ffffff;
}

</style>

</body>